<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P.O.T.A.T.O // Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='cdn/highlight/atom-one-dark.min.css') }}" />
    <script src="{{ url_for('static', filename='cdn/fontawesome/all.min.js') }}"></script>
    <script src="{{ url_for('static', filename='cdn/marked/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='cdn/highlight/highlight.min.js') }}"></script>
  </head>
  <body>
    <div class="scanline"></div>
    <div class="overlay"></div>

    <div class="app-container">
      <!-- Left Sidebar -->
      <aside class="sidebar" id="left-sidebar">
        <div class="sidebar-header">
          <button class="hamburger" id="hamburger-left">
            <i class="fas fa-bars"></i>
          </button>
          <div class="brand">
            <h1>P.O.T.A.T.O</h1>
            <span class="status-indicator">ONLINE</span>
          </div>
        </div>

        <div class="sidebar-content">
          <div class="nav-menu">
            <button class="nav-btn active" onclick="switchTab('chat')">
              <i class="fas fa-comments"></i> <span class="nav-label">CHAT</span>
            </button>
            <button class="nav-btn" onclick="switchTab('vox-core')">
              <i class="fas fa-microphone"></i> <span class="nav-label">VOX CORE</span>
            </button>
            <button class="nav-btn" onclick="switchTab('browser')">
              <i class="fas fa-globe"></i> <span class="nav-label">BROWSER</span>
            </button>
            <button class="nav-btn" onclick="switchTab('settings')">
              <i class="fas fa-cog"></i> <span class="nav-label">SETTINGS</span>
            </button>
            <button class="nav-btn critical" onclick="toggleRightSidebar()">
              <i class="fas fa-database"></i> <span class="nav-label">RAG TOOLS</span>
            </button>
          </div>

          <!-- Model Picker -->
          <div class="model-picker">
            <h3>AI MODEL</h3>
            <select id="model-selector">
              <option value="gpt-oss:20b">Loading models...</option>
            </select>
          </div>

          <!-- Stats Panel -->
          <div class="stats-panel">
            <h3>SYSTEM STATS <span class="stats-indicator" id="stats-indicator"></span></h3>
            <div class="stat-row">
              <span>CPU</span>
              <div class="bar-container">
                <div class="bar" id="cpu-bar"></div>
              </div>
              <span id="cpu-val">0%</span>
            </div>
            <div class="stat-row">
              <span>RAM</span>
              <div class="bar-container">
                <div class="bar" id="ram-bar"></div>
              </div>
              <span id="ram-val">0%</span>
            </div>
            <div class="stat-row">
              <span>GPU</span>
              <div class="bar-container">
                <div class="bar" id="gpu-bar"></div>
              </div>
              <span id="gpu-val">0%</span>
            </div>
            <div class="stat-row">
              <span>VRAM</span>
              <div class="bar-container">
                <div class="bar" id="vram-bar"></div>
              </div>
              <span id="vram-val">0%</span>
            </div>
            <div class="stat-row">
              <span>TEMP</span>
              <span class="temp-display" id="temp-display">0Â°C</span>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Display -->
      <main class="main-display">
        
        <!-- Chat View -->
        <section id="chat-view" class="view-section active">
          <div class="chat-layout">
            <div class="chat-history-sidebar">
              <div class="search-box">
                <input type="text" placeholder="Search chats..." />
              </div>
              <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i> New Chat
              </button>
              <ul class="chat-list" id="chat-list"></ul>
            </div>

            <div class="chat-interface">
              <div class="chat-header">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileMenu()">
                  <i class="fas fa-bars"></i>
                </button>
                <span id="current-model-display">Model: Loading...</span>
                <button class="unload-btn" onclick="unloadChatModel()" title="Unload model from VRAM">
                  <i class="fas fa-eject"></i> Unload
                </button>
                <button class="chat-list-toggle-btn" id="chat-list-toggle-mobile" onclick="toggleChatList()" title="Open chat list">
                  <i class="fas fa-comments"></i>
                </button>
                <button class="rag-toggle-btn" id="rag-toggle-mobile" onclick="toggleRightSidebar()" title="Open RAG tools">
                  <i class="fas fa-database"></i>
                </button>
              </div>
              
              <div class="chat-window" id="chat-window"></div>

              <div class="input-area-container">
                <div class="input-widgets">
                  <label class="widget-icon" title="Upload File">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="file-upload" style="display:none;" onchange="uploadFile(this)" />
                  </label>
                  <label class="widget-icon" title="Upload Folder">
                    <i class="fas fa-folder"></i>
                    <input type="file" webkitdirectory directory multiple id="folder-upload" style="display:none;" onchange="uploadFolder(this)" />
                  </label>
                  <div class="widget-icon" title="Record Voice" onclick="toggleVoiceRecording()">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="widget-icon" title="Web Search" id="web-search-toggle">
                    <i class="fas fa-search"></i>
                  </div>
                  <div class="widget-icon" title="Stealth Mode" id="stealth-toggle">
                    <i class="fas fa-shield-alt"></i>
                  </div>
                </div>
                
                <div class="input-area">
                  <textarea id="chat-input" rows="2" placeholder="Message P.O.T.A.T.O..." onkeydown="handleInputKeydown(event)"></textarea>
                  <button id="send-btn" onclick="sendMessage()" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                  <button id="stop-inference-btn" onclick="stopInference()" class="stop-btn-inline" style="display: none;">
                    <i class="fas fa-stop"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Vox Core View -->
        <section id="vox-core-view" class="view-section">
          <div class="vox-core-container">
            <div class="vox-header">
              <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
              </button>
              <h2>VOX CORE - Interactive Voice Assistant</h2>
              <p class="vox-subtitle">Real-time voice conversation with AI</p>
            </div>

            <div class="vox-settings-bar">
              <div class="vox-setting">
                <label>Voice Chats:</label>
                <div class="vox-chat-selector">
                  <input type="text" id="vox-chat-search" placeholder="Search voice chats..." onkeyup="filterVoiceChats(this.value)">
                  <div class="vox-chat-selector-row">
                    <select id="vox-chat-list" size="1" onchange="loadVoiceChat(this.value)">
                      <option value="">New Voice Chat</option>
                    </select>
                    <button class="vox-delete-btn" onclick="deleteCurrentVoiceChat()" title="Delete selected voice chat">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="vox-setting">
                <label>Language:</label>
                <select id="vox-language" onchange="VOX.setLanguage(this.value)">
                  <option value="en">English</option>
                  <option value="fr">French</option>
                  <option value="es">Spanish</option>
                  <option value="de">German</option>
                  <option value="tr">Turkish</option>
                  <option value="zh">Chinese</option>
                </select>
              </div>

              <div class="vox-setting">
                <label>Audio Device:</label>
                <select id="vox-device-select" onchange="setAudioDevice(this.value, this.options[this.selectedIndex].text)">
                  <option>Loading...</option>
                </select>
              </div>

              <div class="vox-setting">
                <label>
                  <input type="checkbox" id="vox-continuous"> Continuous Mode
                </label>
              </div>

              <div class="vox-setting">
                <label>
                  <input type="checkbox" id="vox-auto-silence" checked> Auto-detect Silence
                </label>
              </div>
            </div>

            <div class="vox-main-area">
              <!-- Whisper Loading Overlay -->
              <div id="vox-loading-overlay" class="vox-loading-overlay" style="display: none;">
                <div class="vox-loading-content">
                  <div class="vox-spinner"></div>
                  <p>Loading Whisper Model...</p>
                  <small>First load may take a moment</small>
                </div>
              </div>

              <div class="vox-chat-window" id="vox-chat-window">
                <!-- Messages will appear here -->
              </div>

              <div class="vox-visualizer">
                <div class="vox-status" id="vox-status">Ready</div>
                <div class="waveform" id="waveform">
                  <div class="wave"></div>
                  <div class="wave"></div>
                  <div class="wave"></div>
                  <div class="wave"></div>
                  <div class="wave"></div>
                </div>
              </div>

              <div class="vox-controls">
                <button class="vox-btn vox-btn-primary" id="vox-record-btn" onclick="if (typeof VOX !== 'undefined') { if (document.getElementById('vox-record-btn').classList.contains('recording')) { VOX.stopRecording(); } else { VOX.startRecording(); } }">
                  <i class="fas fa-microphone"></i> Start Recording
                </button>
                <button class="vox-btn vox-btn-danger" id="vox-stop-speak-btn" onclick="if (typeof VOX !== 'undefined') VOX.stopSpeaking()">
                  <i class="fas fa-volume-mute"></i> Stop Speaking
                </button>
                <button class="vox-btn vox-btn-warning" onclick="unloadSTT()" id="unload-stt-btn">
                  <i class="fas fa-ear-listen"></i> Unload STT
                </button>
                <button class="vox-btn vox-btn-warning" onclick="unloadTTS()" id="unload-tts-btn">
                  <i class="fas fa-volume-high"></i> Unload TTS
                </button>
                <button class="vox-btn vox-btn-secondary" onclick="if (typeof VOX !== 'undefined') VOX.clearChat()">
                  <i class="fas fa-trash"></i> Clear Chat
                </button>
              </div>

              <div class="vox-hints">
                <h3>ðŸ’¡ Tips</h3>
                <ul>
                  <li><strong>Click "Start Recording"</strong> and speak your question</li>
                  <li><strong>Click "Stop Recording"</strong> or let it auto-detect silence</li>
                  <li><strong>Continuous Mode:</strong> Auto-restarts listening after each response</li>
                  <li><strong>Interrupt Words:</strong> Say 'okay thanks', 'alright stop', 'okay enough', 'thank you', 'bye', 'done' or 'shut up' to interrupt</li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Browser View -->
        <section id="browser-view" class="view-section">
          <div class="browser-header">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
              <i class="fas fa-bars"></i>
            </button>
            <span class="url-bar">https://example.com</span>
            <button><i class="fas fa-redo"></i></button>
          </div>
          <div class="browser-placeholder">
            <i class="fas fa-globe"></i>
            <p>Browser View (Placeholder - Playwright mcp browser interval screenshots.)</p>
          </div>
        </section>

        <!-- Settings View -->
        <section id="settings-view" class="view-section">
          <div class="settings-header">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
              <i class="fas fa-bars"></i>
            </button>
            <h2>CONFIGURATION</h2>
            <button class="reset-btn" onclick="resetSettings()">
              <i class="fas fa-undo"></i> Reset to Defaults
            </button>
          </div>
          
          <div class="settings-container">
            <div class="settings-tabs">
              <button class="settings-tab active" onclick="switchSettingsTab('core')">Core LLM</button>
              <button class="settings-tab" onclick="switchSettingsTab('online')">Online Search</button>
              <button class="settings-tab" onclick="switchSettingsTab('rag')">RAG</button>
              <button class="settings-tab" onclick="switchSettingsTab('voice')">Voice</button>
              <button class="settings-tab" onclick="switchSettingsTab('system_prompts')">System Prompts</button>
              <button class="settings-tab" onclick="switchSettingsTab('config')">Configuration</button>
              <button class="settings-tab" onclick="switchSettingsTab('bools')">Features</button>
            </div>

            <div id="settings-content" class="settings-grid">
              <!-- Settings will be dynamically loaded here -->
            </div>

            <button class="save-btn" onclick="saveSettings()">
              <i class="fas fa-save"></i> SAVE SETTINGS
            </button>
          </div>
        </section>

      </main>

      <!-- Right Sidebar (RAG Tools) -->
      <aside class="sidebar right-sidebar" id="right-sidebar">
        <div class="sidebar-header">
          <h3>RAG TOOLS</h3>
          <button class="close-btn" onclick="toggleRightSidebar()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="rag-content">
          <div class="control-group">
            <label>RAG Context (Embed to Vector DB)</label>
            <div class="file-input-wrapper">
              <input type="text" id="rag-folder-display" placeholder="No folder selected" readonly />
              <input type="file" id="rag-folder-input" webkitdirectory directory multiple hidden />
              <button class="action-btn" onclick="document.getElementById('rag-folder-input').click()">
                <i class="fas fa-folder-open"></i> Select Folder
              </button>
            </div>
            <small style="color: #888; display: block; margin-top: 5px;">
              RAG: Embeds files to Weaviate vector DB for semantic search
            </small>
          </div>

          <div class="control-group">
            <label>RAG Image Input (Vision Models)</label>
            <div class="file-input-wrapper">
              <input type="file" id="rag-image-input" accept="image/*" multiple hidden />
              <button class="action-btn" onclick="document.getElementById('rag-image-input').click()">
                <i class="fas fa-image"></i> Select Images
              </button>
              <span id="rag-image-count" style="color: #888; margin-left: 10px;">0 images</span>
            </div>
            <small style="color: #888; display: block; margin-top: 5px;">
              For vision models only - embeds image features to vector DB
            </small>
          </div>

          <div class="control-group">
            <label>Embedding Model</label>
            <select id="rag-embed-model">
              <option value="nomic-embed-text:latest">nomic-embed-text:latest</option>
            </select>
          </div>

          <div class="control-group">
            <label>
              <input type="checkbox" id="rag-enable" /> Enable RAG for Chat
            </label>
          </div>

          <button class="action-btn" onclick="embedFolderContents()">
            <i class="fas fa-database"></i> Embed Folder
          </button>

          <button class="action-btn" onclick="searchRagIndex()">
            <i class="fas fa-search"></i> Search Index
          </button>

          <div class="status-log" id="rag-status">
            Ready to index documents...
          </div>
        </div>
      </aside>
    </div>

    <!-- Voice Recording Overlay -->
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal hidden">
      <div class="confirm-modal-content">
        <h3 id="confirm-modal-title">Confirm Action</h3>
        <p id="confirm-modal-message">Are you sure?</p>
        <div class="confirm-modal-buttons">
          <button class="confirm-btn confirm-btn-cancel" id="confirm-modal-cancel" onclick="closeConfirmModal()">Cancel</button>
          <button class="confirm-btn confirm-btn-danger" id="confirm-modal-confirm">Confirm</button>
        </div>
      </div>
    </div>

    <div id="voice-overlay" class="voice-overlay hidden">
      <div class="voice-container">
        <h2>RECORDING...</h2>
        <div class="voice-language-selector">
          <label for="voice-language-mode">Language:</label>
          <select id="voice-language-mode">
            <option value="translate-en" selected>Translate to English</option>
            <option value="auto">Auto-detect (Keep Original)</option>
            <option value="en">English</option>
            <option value="tr">Turkish</option>
            <option value="fr">French</option>
            <option value="es">Spanish</option>
            <option value="de">German</option>
            <option value="zh">Chinese</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="ar">Arabic</option>
            <option value="ru">Russian</option>
          </select>
        </div>
        <div class="visualizer">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
        </div>
        <button class="close-voice" onclick="stopVoiceRecording()">STOP RECORDING</button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='vox.js') }}"></script>
    <script>
      // VOX models will load only when VOX Core tab is opened
      // No auto-load on page load to save VRAM
      console.log('Page loaded - VOX models will load on demand');
    </script>
  </body>
</html>
